<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Presensi Wajah - Sistem Absensi</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <style>
      body {
        background: #ffffff;
        min-height: 100vh;
        padding: 20px 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .navbar-custom {
        background: rgba(255, 255, 255, 0.95) !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .navbar-brand {
        font-weight: 700;
        font-size: 20px;
        color: #0066cc !important;
      }
      .navbar-brand i {
        margin-right: 8px;
      }
      .container-main {
        max-width: 900px;
        margin: 30px auto;
        padding: 0 20px;
      }
      .page-title {
        color: #0066cc;
        text-align: center;
        margin-bottom: 40px;
        font-weight: 700;
      }
      .page-title h1 {
        font-size: 36px;
        margin-bottom: 10px;
      }
      .page-title p {
        font-size: 16px;
        opacity: 0.9;
        color: #0066cc;
      }
      .card-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
        overflow: hidden;
      }
      .card-header-custom {
        background: #0066cc;
        color: white;
        padding: 20px;
        font-weight: 600;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .card-body-custom {
        padding: 30px;
      }
      .video-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        margin: 0 auto 20px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      }
      #video {
        width: 100%;
        display: block;
        background: #000;
      }
      .btn-capture {
        background: #00aa66;
        border: none;
        border-radius: 10px;
        padding: 14px 30px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s ease;
        color: white;
      }
      .btn-capture:hover {
        transform: translateY(-2px);
        background: #008a52;
        box-shadow: 0 8px 25px rgba(0, 170, 102, 0.4);
        color: white;
      }
      .btn-capture:active {
        transform: translateY(0);
      }
      .btn-capture:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .form-control {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 12px 16px;
        font-size: 14px;
        transition: all 0.3s ease;
      }
      .form-control:focus {
        border-color: #00aa66;
        box-shadow: 0 0 0 0.2rem rgba(0, 170, 102, 0.15);
      }
      .form-control::file-selector-button {
        background: #f5f5f5;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .form-control::file-selector-button:hover {
        background: #e0e0e0;
      }
      .alert-result {
        margin-top: 25px;
        border-radius: 10px;
        border: none;
        display: none;
        animation: slideDown 0.3s ease;
      }
      .alert-result.show {
        display: block;
      }
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .spinner-border-sm {
        width: 18px;
        height: 18px;
        margin-right: 8px;
      }
      .divider {
        position: relative;
        text-align: center;
        margin: 30px 0 25px;
      }
      .divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: #e0e0e0;
      }
      .divider span {
        background: white;
        padding: 0 15px;
        position: relative;
        color: #666;
        font-weight: 600;
      }
      .btn-admin {
        background: #0066cc;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 14px;
        text-align: center;
        transition: all 0.3s ease;
      }
      .btn-admin:hover {
        transform: translateY(-2px);
        background: #0052a3;
        box-shadow: 0 5px 15px rgba(0, 102, 204, 0.3);
      }
      .btn-admin a {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .btn-admin a:hover {
        color: white;
      }
      canvas {
        display: none;
      }

      @media (max-width: 768px) {
        .page-title h1 {
          font-size: 28px;
        }
        .card-body-custom {
          padding: 20px;
        }
        .video-container {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom sticky-top">
      <div class="container-fluid">
        <span class="navbar-brand">
          <i class="bi bi-camera-video"></i> Sistem Presensi Wajah
        </span>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <div class="ms-auto d-flex gap-2 align-items-center">
            <div style="display: flex; gap: 10px; align-items: center">
              <label
                style="
                  margin: 0;
                  font-weight: 600;
                  color: #333;
                  font-size: 14px;
                "
              >
                Model:
              </label>
              <select
                id="modelSelect"
                style="
                  padding: 6px 12px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  font-size: 14px;
                "
              >
                <option value="deepface">DeepFace (Original)</option>
                <option value="tflite">TFLite Float32 (Fast)</option>
                <option value="tflite_fp16">TFLite FP16 (Very Fast)</option>
              </select>
            </div>
            <div class="btn-admin">
              <a href="/admin"> <i class="bi bi-lock"></i> Admin Panel </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container-main">
      <div class="page-title">
        <h1><i class="bi bi-person-check-fill"></i> Presensi Wajah</h1>
        <p>Silakan pilih metode presensi di bawah ini</p>
      </div>

      <!-- CAMERA METHOD -->
      <div class="card-section">
        <div class="card-header-custom">
          <i class="bi bi-camera-fill"></i> Metode 1: Presensi dengan Kamera
        </div>
        <div class="card-body-custom">
          <p class="text-muted mb-4">
            Arahkan wajah ke kamera untuk mengambil foto presensi. Pastikan
            pencahayaan cukup dan wajah terlihat jelas.
          </p>

          <div class="video-container">
            <video id="video" autoplay playsinline></video>
          </div>

          <div class="text-center mb-3">
            <button id="captureBtn" class="btn btn-capture" type="button">
              <i class="bi bi-camera"></i> Ambil Foto & Presensi
            </button>
          </div>

          <canvas id="canvas" width="400" height="300"></canvas>

          <div id="result-camera" class="alert alert-result"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // ======================
      // CAMERA
      // ======================
      let video = document.getElementById("video");
      let captureBtn = document.getElementById("captureBtn");

      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
        })
        .catch((err) => {
          showAlert(
            "result-camera",
            "Error: Tidak bisa mengakses kamera. " + err.message,
            "danger"
          );
          captureBtn.disabled = true;
        });

      captureBtn.onclick = function () {
        captureBtn.disabled = true;
        captureBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm"></span> Memproses...';

        let canvas = document.getElementById("canvas");
        let context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        let imageData = canvas.toDataURL("image/jpeg");
        let modelType = document.getElementById("modelSelect").value;

        let bodyData = new URLSearchParams();
        bodyData.append("image_data", imageData);
        bodyData.append("model_type", modelType);

        fetch("/presensi-kamera", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: bodyData.toString(),
        })
          .then((res) => res.json())
          .then((data) => {
            let alertType = data.status ? "success" : "danger";
            let fullMessage = data.message;
            if (data.status && data.model) {
              fullMessage += ` (Model: ${data.model})`;
            }
            showAlert("result-camera", fullMessage, alertType);
          })
          .catch((err) => {
            showAlert("result-camera", "Error: " + err.message, "danger");
          })
          .finally(() => {
            captureBtn.disabled = false;
            captureBtn.innerHTML =
              '<i class="bi bi-camera"></i> Ambil Foto & Presensi';
          });
      };

      // ======================
      // HELPER FUNCTIONS
      // ======================
      function showAlert(elementId, message, type) {
        let alertElement = document.getElementById(elementId);
        alertElement.className = `alert alert-${type} alert-result show`;

        if (type === "success") {
          alertElement.innerHTML = `<i class="bi bi-check-circle-fill"></i> ${message}`;
        } else {
          alertElement.innerHTML = `<i class="bi bi-exclamation-circle-fill"></i> ${message}`;
        }
      }
    </script>
  </body>
</html>
